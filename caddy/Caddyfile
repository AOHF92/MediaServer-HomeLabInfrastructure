{
  auto_https off
  debug
}

:#### {
    log
    encode zstd gzip

    # ---------- Matchers ----------

    # Komga (Tachimanga etc.) â€“ API paths
    @komga_api {
        host api.example-media.net
        path /api/* /opds/* /sse/*
    }

    # Aniyomi (Android) -> Jellyfin
    @aniyomi {
        host api.example-media.net
        header_regexp ua User-Agent (?i)\bAniyomi\b
    }

    # Jellyfin iOS 

    @jf_ios_root {
        host api.example-media.net
        path /
        header Cf-Warp-Tag-Id .+
    }

    @jf_ios_web {
        host api.example-media.net
        path /web*
        header Cf-Warp-Tag-Id .+
    }

    @jf_ios_other {
        host api.example-media.net
        header Cf-Warp-Tag-Id .+
        not { 
		path /api/* /opds/* /sse/* 
		}
    }

    # Fallback for non-HTML API-ish calls to Jellyfin
    @api_nonhtml {
        host api.example-media.net
        not { 
		path /api/* /opds/* /sse/* 
		}
        not { 
		header Accept *text/html* 
		}
    }

    # UA-based deniers (same as you had)
    @browserUA header_regexp ua User-Agent (?i)(chrome|safari|edge|firefox|opera|brave|vivaldi)
    @aiUA header_regexp ua User-Agent (?i)(GPTBot|ChatGPT|CCBot|Claude|Anthropic|Perplexity|Google-Extended|Bytespider|facebookexternalhit|Diffbot|DataForSeoBot|ai2bot|omgili|omgilibot|cohere|mj12bot|seminarbots?)
    @noUA header User-Agent ""

    # ---------- Routing ----------

    route {
        # 1) Komga first (Tachimanga)
        handle @komga_api {
            reverse_proxy http://host.docker.internal:####
        }

        # 2) Jellyfin iOS (friend device only)
        handle @jf_ios_root {
            reverse_proxy http://host.docker.internal:####
        }
        handle @jf_ios_web {
            reverse_proxy http://host.docker.internal:####
        }
        handle @jf_ios_other {
            reverse_proxy http://host.docker.internal:####
        }

        # 3) Aniyomi (Android) -> Jellyfin
        handle @aniyomi {
            reverse_proxy http://host.docker.internal:####
        }

        # 4) Other non-HTML API-ish calls -> Jellyfin
        handle @api_nonhtml {
            reverse_proxy http://host.docker.internal:####
        }

        # 5) Hard deniers
        respond @browserUA 403
        respond @aiUA 403
        respond @noUA 403

        # 6) Anything else -> 403
        respond 403
    }
}



