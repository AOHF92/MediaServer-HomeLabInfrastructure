services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    # your volumes/ports:
    volumes:
      - "./config:/config"
      - "./cache:/cache"
      - "E:\\Media:/media"
      - "E:/Media:/media:ro"
      - "G:\\Backups\\Jellyfin:/config"
    ports:
      - "8096:8096"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    # Optional: health check so Docker knows if Jellyfin is ready
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8096/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    gpus: all            # <-- this replaces device_requests
    restart: unless-stopped

  komga:
    image: gotson/komga:latest
    container_name: komga
    ports:
      - "25600:25600"
    volumes:
      - "E:\\Media\\Manga:/books:rw"
      - "G:\\Backups\\Komga:/config"
    environment:
      - SERVER_PORT=25600
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    environment:
     - TUNNEL_TOKEN=<placeholder>
    command: tunnel run
    restart: unless-stopped
    
  mihon-gw:
    image: caddy:2
    container_name: mihon-gw
    restart: unless-stopped
    ports:
      - "3001:3001"               # Cloudflared tunnel will point here
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      
volumes:
  caddy_data:
  caddy_config:
